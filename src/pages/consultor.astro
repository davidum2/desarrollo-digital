---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Formulario de consulta"
  description="Formulario para obtener un roadmap de tu emprendimiento"
  keywords="Formulario, desarrollo, emprendimiento, consultoría, negocio"
  robot="follow"
>
  <style>
    .pasos {
      transition: all 0.3s ease-in-out;
      opacity: 0;
      transform: translateX(20px);
      display: none;
    }

    .pasos.active {
      opacity: 1;
      transform: translateX(0);
      display: block;
    }

    .input-error {
      border-color: #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* Animación para el indicador de carga */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }
  </style>

  <div class="min-h-screen flex items-center justify-center p-4">
    <form
      id="consultForm"
      class="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6 md:p-8"
    >
      <!--Progreso -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm text-gray-600" id="step-counter"
            >Paso 1 de 5</span
          >
          <span class="text-sm text-gray-600" id="step-percentage">20%</span>
        </div>
        <div class="step-indicator flex-1 h-2 bg-gray-200 rounded-full">
          <div
            class="h-full bg-blue-600 rounded-full transition-all duration-300"
            style="width: 20%"
            id="progress-bar"
          >
          </div>
        </div>
      </div>

      <!-- Paso 1: Claves del éxito -->
      <div class="pasos active" data-step="1">
        <h1 class="text-3xl text-center font-bold text-gray-800 mb-4">
          Tu camino hacia el éxito
        </h1>
        <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">
          Claves de un Negocio Exitoso (Sin Jerga Complicada)
        </h2>
        <div class="space-y-4 text-gray-600">
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Tener algo valioso que ofrecer: Que resuelva un problema o satisfaga
            una necesidad
          </p>
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Saber a quién se lo ofreces: Conocer bien a tus clientes ideales
          </p>
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Ser diferente o mejor: Destacar de la competencia con una propuesta única
          </p>
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Tener una meta clara: Saber a dónde quieres llegar
          </p>
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Ser constante: No rendirse ante los obstáculos
          </p>
          <p class="flex items-start">
            <span class="mr-2">•</span>
            Adaptarse: Cambiar si algo no funciona y buscar mejorar
          </p>
        </div>
      </div>

      <!-- Paso 2: Preguntas Guiadas -->
      <div class="pasos" data-step="2">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          Formulario de Preguntas Guiadas
        </h2>
        <div class="space-y-8">
          <!-- Pregunta 1 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              ¿Qué problema resuelve tu negocio? (Propuesta de valor)
            </h3>
            <label class="block text-gray-600 mb-2">
              Piensa en qué necesidad satisfaces o qué problema le quitas a tus
              clientes. No te enfoques en lo que vendes, sino en el beneficio
              que les das.
            </label>
            <textarea
              data-validate="required"
              name="propuestaValor"
              placeholder="Ej: No vendes 'café', vendes 'una pausa en el día'"
              class="w-full px-4 py-3 rounded-lg border-2 text-gray-700 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none"
              rows="3"></textarea>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <!-- Pregunta 2 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              ¿A quién le quieres vender? (Público objetivo)
            </h3>
            <label class="block text-gray-600 mb-2">
              Describe a tu cliente ideal, ¿quiénes son esas personas que más se
              beneficiarían de tu producto o servicio?
            </label>
            <textarea
              data-validate="required"
              name="publicoObjetivo"
              placeholder="Ej: Mujeres entre 25 y 60 años que les gusta una vida saludable"
              class="w-full px-4 py-3 rounded-lg border-2 text-gray-700 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none"
              rows="3"></textarea>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>
        </div>
      </div>

      <!-- Paso 3: Cliente ideal y Necesidad actual -->
      <div class="pasos" data-step="3">
        <div class="space-y-8">
          <!-- Pregunta 3 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              Si pudieras tener un cliente ideal, ¿cómo sería? (Cliente ideal)
            </h3>
            <label class="block text-gray-600 mb-2">
              Piensa en ese cliente que ama lo que vendes, que te compra seguido
              y que te recomienda a sus amigos.
            </label>
            <textarea
              data-validate="required"
              name="clienteIdeal"
              placeholder="Ej: Personas que valoren la calidad sobre el precio"
              class="w-full px-4 py-3 rounded-lg border-2 text-gray-700 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none"
              rows="3"></textarea>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <!-- Pregunta 4 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              ¿Cómo está tu negocio ahorita? (Necesidad actual)
            </h3>
            <label class="block text-gray-600 mb-2">
              ¿Ya tienes un local, vendes por redes sociales o apenas estás
              empezando con una idea?
            </label>
            <textarea
              data-validate="required"
              name="necesidadActual"
              placeholder="Ej: No tienes página web, quieres empezar a vender por internet"
              class="w-full px-4 py-3 rounded-lg border-2 text-gray-700 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none"
              rows="3"></textarea>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>
        </div>
      </div>

      <!-- Paso 4: Presupuesto y Metas -->
      <div class="pasos" data-step="4">
        <div class="space-y-8">
          <!-- Pregunta 5 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              ¿Cuánto quieres invertir en tu negocio para llegar a tus metas?
              (Presupuesto)
            </h3>
            <label class="block text-gray-600 mb-2">
              No se trata de "cuánto dinero tienes", sino de cuánto estás
              dispuesto a invertir para impulsar tu negocio.
            </label>
            <div class="relative">
              <div class="flex">
                <div
                  class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
                >
                  <span id="currency-symbol" class="text-gray-700">$</span>
                </div>
                <input
                  name="presupuesto"
                  data-validate="required"
                  type="number"
                  class="w-full pl-10 px-4 py-3 rounded-lg border-2 text-gray-700 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                  placeholder="0.00"
                  inputmode="numeric"
                  min="0"
                  step="0.01"
                />
              </div>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <select
                  id="currency-select"
                  name="moneda"
                  class="border border-gray-300 text-gray-700 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all"
                >
                  <option value="MXN">MXN</option>
                  <option value="USD" selected>USD</option>
                </select>
              </div>
            </div>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <!-- Pregunta 6 -->
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">
              ¿Qué quieres lograr con tu negocio en internet? (Metas SMART)
            </h3>
            <label class="block text-gray-600 mb-2">
              Tus metas deben ser específicas, medibles, alcanzables, realistas
              y con un tiempo definido.
            </label>
            <textarea
              data-validate="required"
              name="metas"
              placeholder="Ej: Quiero aumentar mis ventas un 20% en los próximos 3 meses"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none text-gray-700"
              rows="3"></textarea>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>
        </div>
      </div>

      <!-- Paso 5: Contacto -->
      <div class="pasos" data-step="5">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          Tu información de contacto
        </h2>
        <div class="space-y-6">
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">
              ¿Cómo quieres que te gusta que te llamen (tu nombre)?
            </label>
            <input
              data-validate="required"
              name="nombreCliente"
              type="text"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-gray-700"
              placeholder="Tu nombre"
            />
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">
              Nombre de tu producto o servicio
            </label>
            <input
              data-validate="required"
              name="marca"
              type="text"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-gray-700"
              placeholder="Nombre de tu negocio o marca"
            />
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">
              Correo electrónico
            </label>
            <input
              data-validate="email"
              name="correo"
              type="email"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-gray-700"
              placeholder="ejemplo@correo.com"
            />
            <span class="error-message hidden">Ingresa un correo válido</span>
          </div>

          <div data-validate="required">
            <label class="block text-gray-700 text-sm font-medium mb-2">
              Teléfono (WhatsApp)
            </label>
            <div class="flex">
              <!-- Select con banderas, ladas y países -->
              <select
                name="lada"
                class="w-32 border border-gray-300 rounded-l-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-all border-r-0 text-gray-700"
              >
                <option value="+54">🇦🇷 (+54)</option>
                <option value="+591">🇧🇴 (+591)</option>
                <option value="+56">🇨🇱 (+56)</option>
                <option value="+57">🇨🇴 (+57)</option>
                <option value="+506">🇨🇷 (+506)</option>
                <option value="+53">🇨🇺 (+53)</option>
                <option value="+593">🇪🇨 (+593)</option>
                <option value="+503">🇸🇻 (+503)</option>
                <option value="+34">🇪🇸 (+34)</option>
                <option value="+1">🇺🇸 (+1)</option>
                <option value="+240">🇬🇶 (+240)</option>
                <option value="+502">🇬🇹 (+502)</option>
                <option value="+504">🇭🇳 (+504)</option>
                <option value="+52" selected>🇲🇽 (+52)</option>
                <option value="+505">🇳🇮 (+505)</option>
                <option value="+507">🇵🇦 (+507)</option>
                <option value="+595">🇵🇾 (+595)</option>
                <option value="+51">🇵🇪 (+51)</option>
                <option value="+1-809">🇩🇴 (+1-809)</option>
                <option value="+598">🇺🇾 (+598)</option>
                <option value="+58">🇻🇪 (+58)</option>
              </select>

              <!-- Campo de entrada para el número de teléfono -->
              <input
                data-validate="required|phone"
                name="telefono"
                type="tel"
                placeholder="Ej: 1234567890"
                class="w-full border border-gray-300 rounded-r-md px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all border-l-0 text-gray-700"
              />
            </div>
            <span class="error-message hidden">Este campo es requerido</span>
          </div>

          <!-- Términos y Condiciones y Política de Privacidad -->
          <div class="mt-4">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="acceptTerms"
                data-validate="required"
                class="form-checkbox h-5 w-5 text-blue-600"
              />
              <span class="ml-2 text-gray-700 text-sm">
                Acepto la
                <a
                  href="/politica-privacidad"
                  target="_blank"
                  class="text-blue-500 underline"
                >
                  Política de Privacidad
                </a>
                y los
                <a
                  href="/terminosYcondiciones"
                  target="_blank"
                  class="text-blue-500 underline"
                >
                  Términos y Condiciones
                </a>.
              </span>
            </label>
            <!-- Opcional: Puedes agregar un span para mensajes de error, si lo validas con JS -->
            <span class="error-message hidden"
              >Debes aceptar los términos y condiciones</span
            >
          </div>
        </div>
      </div>

      <!-- Notificación de éxito o error -->
      <div id="notification" class="hidden mt-4 p-4 rounded-lg text-center">
        <p id="notification-message"></p>
      </div>

      <!-- Navegación -->
      <div class="mt-8 flex flex-col md:flex-row gap-4 justify-between">
        <button
          type="button"
          class="btn-prev w-full md:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors hidden"
        >
          <span>Anterior</span>
        </button>
        <button
          type="button"
          class="btn-next w-full md:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <span>Siguiente</span>
        </button>
        <button
          type="submit"
          class="btn-submit w-full md:w-auto px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden"
        >
          <span>Enviar solicitud</span>
          <svg
            id="loading-spinner"
            class="hidden ml-2 w-5 h-5 spinner inline-block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </form>

    <script type="module">
      class MultiStepForm {
        constructor() {
          this.form = document.getElementById('consultForm');
          this.steps = Array.from(document.querySelectorAll('.pasos'));
          this.currentStep = 0;
          this.progress = document.getElementById('progress-bar');
          this.stepCounter = document.getElementById('step-counter');
          this.stepPercentage = document.getElementById('step-percentage');
          this.notification = document.getElementById('notification');
          this.notificationMessage = document.getElementById(
            'notification-message'
          );
          this.loadingSpinner = document.getElementById('loading-spinner');
          this.submitButton = document.querySelector('.btn-submit');

          this.init();
        }

        init() {
          this.setupEventListeners();
          this.updateUI();
        }

        setupEventListeners() {
          document
            .querySelector('.btn-next')
            .addEventListener('click', () => this.nextStep());
          document
            .querySelector('.btn-prev')
            .addEventListener('click', () => this.prevStep());

          // Para cada input o textarea, se realiza validación en el evento input
          this.form
            .querySelectorAll('input, textarea, select')
            .forEach((input) => {
              input.addEventListener('input', () => this.validateField(input));
              input.addEventListener('change', () => this.validateField(input));

              // Validación inicial para campos con valores predeterminados
              if (input.value) {
                this.validateField(input);
              }
            });

          // Manejar el envío del formulario
          this.form.addEventListener('submit', (event) =>
            this.handleSubmit(event)
          );
        }

        validateField(field) {
          if (!field.dataset.validate) return true;

          // Buscar el contenedor del campo para encontrar el mensaje de error
          let container = field.closest('div');
          let errorMessage;

          // Para el checkbox de términos y condiciones
          if (field.type === 'checkbox') {
            errorMessage =
              field.parentElement.parentElement.querySelector('.error-message');
          } else {
            // Para otros campos, buscar el mensaje de error en el contenedor
            errorMessage = container.nextElementSibling;
            if (
              !errorMessage ||
              !errorMessage.classList.contains('error-message')
            ) {
              errorMessage = container.querySelector('.error-message');
            }
          }

          const validationTypes = field.dataset.validate.split('|');
          let isValid = true;
          let errorText = '';

          for (const type of validationTypes) {
            if (type === 'required' && !this.isRequired(field)) {
              isValid = false;
              errorText = 'Este campo es requerido';
              break;
            } else if (type === 'email' && !this.isValidEmail(field.value)) {
              isValid = false;
              errorText = 'Ingresa un correo válido';
              break;
            } else if (type === 'phone' && !this.isValidPhone(field.value)) {
              isValid = false;
              errorText = 'Ingresa un número de teléfono válido';
              break;
            }
          }

          if (!isValid) {
            this.showError(field, errorMessage, errorText);
            return false;
          } else {
            this.clearError(field, errorMessage);
            return true;
          }
        }

        isRequired(field) {
          if (field.type === 'checkbox') {
            return field.checked;
          }
          return field.value.trim() !== '';
        }

        isValidEmail(email) {
          return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        isValidPhone(phone) {
          // Validar que sea un número de teléfono válido (solo dígitos, mínimo 8 caracteres)
          return /^\d{8,15}$/.test(phone);
        }

        showError(field, errorElement, message) {
          field.classList.add('input-error');
          if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
          }
        }

        clearError(field, errorElement) {
          field.classList.remove('input-error');
          if (errorElement) {
            errorElement.classList.add('hidden');
          }
        }

        nextStep() {
          if (!this.validateStep(this.steps[this.currentStep])) return;

          this.steps[this.currentStep].classList.remove('active');
          this.currentStep++;
          this.steps[this.currentStep].classList.add('active');
          this.updateProgress();
          this.updateUI();

          // Scroll al inicio del formulario para mejor experiencia móvil
          this.form.scrollIntoView({ behavior: 'smooth' });
        }

        prevStep() {
          this.steps[this.currentStep].classList.remove('active');
          this.currentStep--;
          this.steps[this.currentStep].classList.add('active');
          this.updateProgress();
          this.updateUI();

          // Scroll al inicio del formulario para mejor experiencia móvil
          this.form.scrollIntoView({ behavior: 'smooth' });
        }

        validateStep(step) {
          // El paso 1 no requiere validación
          if (parseInt(step.dataset.step) === 1) return true;

          let isValid = true;
          const fields = step.querySelectorAll('[data-validate]');

          fields.forEach((field) => {
            if (!this.validateField(field)) {
              isValid = false;
            }
          });

          return isValid;
        }

        updateProgress() {
          const progressWidth =
            ((this.currentStep + 1) / this.steps.length) * 100;
          this.progress.style.width = `${progressWidth}%`;
          this.stepCounter.textContent = `Paso ${this.currentStep + 1} de ${this.steps.length}`;
          this.stepPercentage.textContent = `${Math.round(progressWidth)}%`;
        }

        updateUI() {
          const prevButton = document.querySelector('.btn-prev');
          const nextButton = document.querySelector('.btn-next');
          const submitButton = document.querySelector('.btn-submit');

          prevButton.classList.toggle('hidden', this.currentStep === 0);
          nextButton.classList.toggle(
            'hidden',
            this.currentStep === this.steps.length - 1
          );
          submitButton.classList.toggle(
            'hidden',
            this.currentStep !== this.steps.length - 1
          );
        }

        showNotification(message, isSuccess) {
          this.notification.classList.remove('hidden');

          if (isSuccess) {
            this.notification.classList.add('bg-green-100', 'text-green-800');
          } else {
            this.notification.classList.add('bg-red-100', 'text-red-800');
          }

          this.notificationMessage.textContent = message;

          // Auto-ocultar después de 5 segundos
          setTimeout(() => {
            this.notification.classList.add('hidden');
          }, 5000);
        }

        handleSubmit(event) {
          event.preventDefault();

          // Validar el paso actual antes de enviar
          if (!this.validateStep(this.steps[this.currentStep])) return;

          // Mostrar indicador de carga
          this.loadingSpinner.classList.remove('hidden');
          this.submitButton.disabled = true;

          const datosFormulario = new FormData(this.form);

          fetch(
            'https://um215.app.n8n.cloud/webhook-test/04611043-2749-4dfb-824d-ac10c9437dc2',
            {
              method: 'POST',
              body: datosFormulario,
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
              }
              return response.json();
            })
            .then((data) => {
              console.log('Datos enviados a n8n:', data);
              this.showNotification(
                '¡Formulario enviado con éxito! Revise su bandeja de correo',
                true
              );
              this.form.reset();

              // Redirigir a la página de gracias después de 2 segundos
              setTimeout(() => {
                window.location.href = '/gracias';
              }, 2000);
            })
            .catch((error) => {
              console.error('Error al enviar datos a n8n:', error);
              this.showNotification(
                'Error al enviar el formulario. Inténtalo de nuevo.',
                false
              );
            })
            .finally(() => {
              // Ocultar indicador de carga
              this.loadingSpinner.classList.add('hidden');
              this.submitButton.disabled = false;
            });
        }
      }

      const multiStepForm = new MultiStepForm();
    </script>
  </div>
</Layout>
